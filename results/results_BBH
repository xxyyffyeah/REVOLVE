âº Optimizer v1 vs v2 æ ¸å¿ƒåŒºåˆ«åˆ†æ

  ä¸»è¦å·®å¼‚

  1. æç¤ºæ¨¡æ¿ç³»ç»Ÿ

  - v1: ä½¿ç”¨ optimizer_prompts.py
  - v2: ä½¿ç”¨ optimizer_prompts_v2.py - æ›´å¼ºè°ƒå“åº”æ¼”åŒ–è·Ÿè¸ª

  2. å†å²å€¼è·Ÿè¸ªæœºåˆ¶

  v1 (ä¼ ç»ŸTextGradæ–¹å¼):
  - åªåœ¨åŠ¨é‡ä¼˜åŒ–å™¨ä¸­è·Ÿè¸ªå†å²
  - å†å²ä¿¡æ¯å­˜å‚¨åœ¨ momentum_storage

  v2 (REVOLVEæ–¹å¼):
  - æ‰€æœ‰ä¼˜åŒ–å™¨éƒ½è·Ÿè¸ªå†å²å€¼
  - æ–°å¢ past_values_dict ä¸“é—¨å­˜å‚¨å˜é‡æ¼”åŒ–å†å²
  - æ–°å¢ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•:
    - get_past_values_text(): æ ¼å¼åŒ–å†å²å€¼
    - update_past_values(): æ›´æ–°å†å²è®°å½•

  3. ä¼˜åŒ–æç¤ºç­–ç•¥

  v1: åŸºäºå½“å‰æ¢¯åº¦çš„å³æ—¶åé¦ˆ
  v2: åŸºäºæ¼”åŒ–è½¨è¿¹çš„ä¼˜åŒ–æŒ‡å¯¼:
  # v2 æç¤ºå¼ºè°ƒæ¼”åŒ–è·Ÿè¸ª
  "Additionally, reflect on how the responses to this variable have evolved across iterations"
  "Make nuanced improvements...ensure that the response evolves in a coherent and thoughtful manner"

  4. ä¸Šä¸‹æ–‡å¢å¼º

  v2:
  # ç¡®ä¿past_valuesè¢«åŒ…å«åœ¨æ¢¯åº¦ä¸Šä¸‹æ–‡ä¸­
  if 'past_values' not in context:
      context['past_values'] = "No past values available"

  REVOLVEä¼˜åŠ¿ä½“ç°

  1. ç¨³å®šæ€§: é€šè¿‡è·Ÿè¸ªæ¼”åŒ–è½¨è¿¹é¿å…æŒ¯è¡
  2. è¿ç»­æ€§: ç¡®ä¿ä¼˜åŒ–è¿‡ç¨‹çš„æ¸è¿›å¼æ”¹è¿›
  3. ä¸Šä¸‹æ–‡æ„ŸçŸ¥: åŸºäºå†å²è¡¨ç°åšå‡ºæ›´æ˜æ™ºçš„è°ƒæ•´
  4. é˜²æ­¢è¿‡åº¦å˜åŒ–: é¿å…åœ¨ç›¸ä¼¼é”™è¯¯çŠ¶æ€é—´åå¤è·³è·ƒ

  ç»“è®º: v2æ˜¯REVOLVEçš„æ ¸å¿ƒå®ç°ï¼Œé€šè¿‡å“åº”æ¼”åŒ–è·Ÿè¸ªæœºåˆ¶å®ç°æ¯”ä¼ ç»ŸTextGradæ›´ç¨³å®šå’Œé«˜æ•ˆçš„ä¼˜åŒ–è¿‡ç¨‹ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ çš„æµ‹è¯•ç»“æœæ˜¾ç¤ºv2ç‰ˆæœ¬
  èƒ½è¾¾åˆ°78.92%çš„ç¨³å®šå‡†ç¡®ç‡ã€‚

> è¿™é‡Œçš„past valueåŒ…å«äº†ä»€ä¹ˆ

âº è®©æˆ‘åˆ†æpast_valuesçš„å…·ä½“å†…å®¹å’Œç”¨é€”ï¼š

âº Search(pattern: "update_past_values", path: "../textgrad/optimizer", output_mode: "content")
  â¿  Found 23 lines (ctrl+r to expand)

âº Search(pattern: "variable\.value", path: "../textgrad/optimizer/optimizer_v2.py", output_mode: "content")
  â¿  Found 22 lines (ctrl+r to expand)

âº è®©æˆ‘æŸ¥çœ‹å…·ä½“çš„Variableå€¼æ˜¯ä»€ä¹ˆï¼š

âº Read(prompts)
  â¿  Read 20 lines (ctrl+r to expand)

âº Past Values åŒ…å«çš„å†…å®¹

  åŸºäºä»£ç åˆ†æï¼Œpast_values åŒ…å«çš„æ˜¯ï¼š

  æ ¸å¿ƒå†…å®¹

  self.past_values_dict[variable].append(variable.value)

  past_values å­˜å‚¨çš„æ˜¯ variable.value çš„å†å²ç‰ˆæœ¬ï¼Œå³ï¼š

  å…·ä½“å†…å®¹ï¼ˆä»¥BBHä¸ºä¾‹ï¼‰

  Variableç±»å‹: System Promptï¼ˆç”¨äºæŒ‡å¯¼LLMå›ç­”æ¨ç†é—®é¢˜ï¼‰

  Past Values ç¤ºä¾‹:
  Iteration 1: You will answer a reasoning question. Begin by identifying and listing each category of items and their
  respective counts. Clearly articulate each step of your reasoning process, ensuring that all components are accounted for.
  After completing your calculations, perform a self-check to verify the accuracy of your answer. If any assumptions are made,
  state and justify them. The last line of your response should be of the following format: 'Answer: $VALUE' where VALUE is a
  numerical value.

  Iteration 2: [ä¼˜åŒ–åçš„promptç‰ˆæœ¬1]

  Iteration 3: [ä¼˜åŒ–åçš„promptç‰ˆæœ¬2]
  ...

  æ ¼å¼åŒ–è¾“å‡º

  return "\n".join([f"Iteration {i+1}: {value}" for i, value in enumerate(past_values)])

  ç”¨é€”å’Œä»·å€¼

  1. æ¼”åŒ–è·Ÿè¸ª: è§‚å¯Ÿpromptå¦‚ä½•ä»åˆå§‹ç‰ˆæœ¬é€æ­¥æ”¹è¿›
  2. é¿å…é‡å¤é”™è¯¯: é˜²æ­¢å›åˆ°ä¹‹å‰è¡¨ç°ä¸ä½³çš„ç‰ˆæœ¬
  3. è¶‹åŠ¿åˆ†æ: è¯†åˆ«å“ªäº›æ”¹è¿›æ–¹å‘æœ‰æ•ˆ
  4. ç¨³å®šæ€§ä¿è¯: ç¡®ä¿æ”¹è¿›æ˜¯æ¸è¿›å¼çš„ï¼Œè€Œéå‰§çƒˆè·³è·ƒ
  5. ä¸Šä¸‹æ–‡ä¿æŒ: è®©ä¼˜åŒ–å™¨äº†è§£"æˆ‘ä»¬ä»å“ªé‡Œæ¥ï¼Œè¦åˆ°å“ªé‡Œå»"

  å…³é”®åŒºåˆ«

  - æ¢¯åº¦(gradients): å‘Šè¯‰ä½ "ä»€ä¹ˆåœ°æ–¹ä¸å¥½"
  - Past Values: å‘Šè¯‰ä½ "ä¹‹å‰å°è¯•äº†ä»€ä¹ˆ"

  è¿™å°±æ˜¯REVOLVEç›¸æ¯”TextGradçš„æ ¸å¿ƒåˆ›æ–°ï¼šä¸ä»…åŸºäºåé¦ˆä¼˜åŒ–ï¼Œè¿˜åŸºäºæ¼”åŒ–å†å²åšå‡ºæ›´æ˜æ™ºçš„å†³ç­–ã€‚

> æ‰€æœ‰çš„çš„past valueséƒ½ä¼šè¢«ä¼ å…¥åˆ°å¯¹promptçš„ä¼˜åŒ–å—

âº è®©æˆ‘åˆ†æpast valuesæ˜¯å¦‚ä½•è¢«ä¼ å…¥promptä¼˜åŒ–çš„ï¼š

âº Search(pattern: "past_values.*prompt\|prompt.*past_values", path: "../textgrad/optimizer", output_mode: "content")
  â¿  Found 0 lines 

âº Read(../textgrad/optimizer/optimizer_prompts_v2.py)
  â¿  Read 50 lines (ctrl+r to expand)

âº Search(pattern: "PAST_ITERATIONS.*past_values", path: "../textgrad/optimizer", output_mode: "content")
  â¿  Found 29 lines (ctrl+r to expand)

âº Search(pattern: "construct_tgd_prompt", path: "../textgrad/optimizer/optimizer_prompts_v2.py", output_mode: "content")
  â¿  Found 10 lines (ctrl+r to expand)

âº åˆ†æ: Past Values å¦‚ä½•ä¼ å…¥ä¼˜åŒ–Prompt

  ç­”æ¡ˆ: æ˜¯çš„ï¼Œæ‰€æœ‰past valueséƒ½ä¼šè¢«ä¼ å…¥

  åŸºäºä»£ç åˆ†æï¼š

  1. åœ¨v2ä¼˜åŒ–å™¨ä¸­çš„ä¼ å…¥æœºåˆ¶

  # optimizer_v2.py ç¬¬197è¡Œ
  past_values = self.get_past_values_text(variable)  # è·å–æ‰€æœ‰å†å²å€¼

  optimizer_information = {
      "past_values": past_values,  # ä¼ å…¥æ‰€æœ‰å†å²
      # ... å…¶ä»–å‚æ•°
  }

  2. Past Values åœ¨Promptæ¨¡æ¿ä¸­çš„ä½ç½®

  # optimizer_prompts_v2.py
  TGD_PROMPT_PREFIX = (
      "Here is the role of the variable you will improve: <ROLE>{variable_desc}</ROLE>.\n\n"
      "The variable is the text within the following span: <VARIABLE> {variable_short} </VARIABLE>\n\n"
      "Here is the context and feedback we received for the variable:\n\n"
      "<CONTEXT>{variable_grad}</CONTEXT>\n\n"
      "Additionally, reflect on how the responses to this variable have evolved across iterations:\n\n"
      "<PAST_ITERATIONS>{past_values}</PAST_ITERATIONS>\n\n"  # â† æ‰€æœ‰å†å²è¢«æ³¨å…¥è¿™é‡Œ
      "Make nuanced improvements..."
  )

  3. æ ¼å¼åŒ–åçš„å®é™…å†…å®¹

  <PAST_ITERATIONS>
  Iteration 1: You will answer a reasoning question. Begin by identifying...
  Iteration 2: [æ”¹è¿›ç‰ˆæœ¬1]
  Iteration 3: [æ”¹è¿›ç‰ˆæœ¬2]
  ...
  Iteration N: [æœ€æ–°ç‰ˆæœ¬]
  </PAST_ITERATIONS>

  4. æ½œåœ¨é—®é¢˜

  Tokené™åˆ¶: éšç€è¿­ä»£å¢åŠ ï¼Œpast valuesä¼šè¶Šæ¥è¶Šé•¿ï¼Œå¯èƒ½å¯¼è‡´ï¼š
  - è¶…å‡ºæ¨¡å‹ä¸Šä¸‹æ–‡çª—å£
  - å¢åŠ è®¡ç®—æˆæœ¬
  - å¯èƒ½å¹²æ‰°ä¼˜åŒ–ç„¦ç‚¹

  ä½†ç›®å‰ä»£ç ä¸­æ²¡æœ‰é•¿åº¦é™åˆ¶æœºåˆ¶ï¼Œæ„å‘³ç€ï¼š
  - âœ… æ‰€æœ‰å†å²ç‰ˆæœ¬éƒ½ä¼šè¢«åŒ…å«
  - âš ï¸ é•¿æœŸè¿è¡Œå¯èƒ½é‡åˆ°tokené™åˆ¶
  - ğŸ’¡ æœªæ¥å¯èƒ½éœ€è¦æ·»åŠ å†å²æˆªæ–­æœºåˆ¶

  5. å¯¹æ¯”v1

  - v1: åªåœ¨åŠ¨é‡ä¼˜åŒ–å™¨ä¸­åŒ…å«éƒ¨åˆ†å†å²
  - v2: æ‰€æœ‰ä¼˜åŒ–å™¨éƒ½åŒ…å«å®Œæ•´å†å²ï¼Œè¿™æ˜¯REVOLVEçš„æ ¸å¿ƒç‰¹å¾

  æ‰€ä»¥å›ç­”ä½ çš„é—®é¢˜ï¼šæ˜¯çš„ï¼Œæ‰€æœ‰çš„past valueséƒ½ä¼šè¢«ä¼ å…¥åˆ°promptä¼˜åŒ–ä¸­ï¼Œè¿™æ­£æ˜¯REVOLVEç›¸æ¯”TextGradçš„å…³é”®æ”¹è¿›ã€‚

> åˆ†æä¸¤ç§åœ¨optimizer promptä¸Šçš„å·®å¼‚

âº è®©æˆ‘åˆ†æv1å’Œv2åœ¨optimizer promptä¸Šçš„å·®å¼‚ï¼š

âº Read(../textgrad/optimizer/optimizer_prompts.py)
  â¿  Read 100 lines (ctrl+r to expand)

âº Read(../textgrad/optimizer/optimizer_prompts_v2.py)
  â¿  Read 100 lines (ctrl+r to expand)

âº Optimizer Prompt å·®å¼‚å¯¹æ¯”åˆ†æ

  1. ç³»ç»Ÿæç¤ºè¯ï¼ˆOPTIMIZER_SYSTEM_PROMPTï¼‰å·®å¼‚

  V1 (TextGradåŸç‰ˆ)

  "You are part of an optimization system that improves text (i.e., variable).
  You will be asked to creatively and critically improve prompts, solutions to problems, code, or any other text-based
  variable.
  You will receive some feedback, and use the feedback to improve the variable.
  The feedback may be noisy, identify what is important and what is correct."

  V2 (REVOLVE)

  "You are part of an optimization system that improves text (i.e., variable) by analyzing how the responses evolve across
  multiple iterations.
  Your goal is not just to make a single improvement, but to ensure that the variable evolves naturally and meaningfully over
  time.
  Focus on adjusting the variable in a way that each step introduces thoughtful, measured changes based on past iterations,
  rather than drastic shifts."

  æ ¸å¿ƒå·®å¼‚:
  - V1: ä¸“æ³¨äº"åŸºäºåé¦ˆæ”¹è¿›"
  - V2: å¼ºè°ƒ"æ¼”åŒ–åˆ†æ"å’Œ"åŸºäºå†å²çš„æ¸è¿›æ”¹è¿›"

  2. ä¸»è¦æç¤ºç»“æ„ï¼ˆTGD_PROMPT_PREFIXï¼‰å·®å¼‚

  V1

  "Here is the context and feedback we got for the variable:
  <CONTEXT>{variable_grad}</CONTEXT>

  Improve the variable ({variable_desc}) using the feedback provided in <FEEDBACK> tags."

  V2

  "Here is the context and feedback we received for the variable:
  <CONTEXT>{variable_grad}</CONTEXT>

  Additionally, reflect on how the responses to this variable have evolved across iterations:
  <PAST_ITERATIONS>{past_values}</PAST_ITERATIONS>

  Make nuanced improvements, keeping in mind that too-similar responses suggest insufficient change, but avoid making overly
  large changes.
  Ensure that the response evolves in a coherent and thoughtful manner that aligns with the context, feedback, and past
  responses."

  æ ¸å¿ƒå·®å¼‚:
  - V1: å†å²ä¿¡æ¯ä»…åœ¨åŠ¨é‡æ¨¡å¼ä¸‹å¯é€‰æ·»åŠ 
  - V2: å†å²ä¿¡æ¯é»˜è®¤åŒ…å«ï¼Œå¹¶æ˜ç¡®è¦æ±‚åŸºäºæ¼”åŒ–è½¨è¿¹ä¼˜åŒ–

  3. åŠ¨é‡æç¤ºï¼ˆMOMENTUM_PROMPT_ADDITIONï¼‰å·®å¼‚

  V1

  "Similar feedbacks across different steps suggests that the modifications to the variable are insufficient.
  If this is the case, please make more significant changes to the variable."

  V2

  "If similar feedbacks keep appearing, it suggests insufficient changes to the variable.
  Make significant, varied changes to ensure the response evolves in a unique and diverse direction."

  å·®å¼‚:
  - V1: æ¶ˆæå“åº”ï¼Œ"å¦‚æœç›¸ä¼¼å°±åŠ å¤§æ”¹å˜"
  - V2: ç§¯æå¼•å¯¼ï¼Œ"ç¡®ä¿ç‹¬ç‰¹å’Œå¤šæ ·åŒ–çš„æ¼”åŒ–æ–¹å‘"

  4. å…³é”®è®¾è®¡å“²å­¦å·®å¼‚

  | æ–¹é¢   | V1 (TextGrad) | V2 (REVOLVE)  |
  |------|---------------|---------------|
  | ä¼˜åŒ–ç›®æ ‡ | åŸºäºåé¦ˆçš„å³æ—¶æ”¹è¿›     | åŸºäºæ¼”åŒ–è½¨è¿¹çš„æ¸è¿›ä¼˜åŒ–   |
  | å†å²ä½¿ç”¨ | å¯é€‰çš„åŠ¨é‡ä¿¡æ¯       | æ ¸å¿ƒçš„æ¼”åŒ–åˆ†æ       |
  | æ”¹è¿›ç­–ç•¥ | ååº”å¼è°ƒæ•´         | é¢„æµ‹æ€§æ¼”åŒ–         |
  | ç¨³å®šæ€§  | å¯èƒ½å‡ºç°æŒ¯è¡        | å¼ºè°ƒè¿ç»­æ€§å’Œä¸€è‡´æ€§     |
  | æŒ‡å¯¼åŸåˆ™ | "ä½¿ç”¨åé¦ˆæ”¹è¿›"      | "ç¡®ä¿è‡ªç„¶ä¸”æœ‰æ„ä¹‰çš„æ¼”åŒ–" |

  5. å®é™…å½±å“

  V1çš„é—®é¢˜:
  - å¯èƒ½åœ¨ç›¸ä¼¼çŠ¶æ€é—´åå¤è·³è·ƒ
  - ç¼ºä¹é•¿æœŸæ¼”åŒ–è§†è§’
  - å®¹æ˜“å‡ºç°å‰§çƒˆå˜åŒ–

  V2çš„ä¼˜åŠ¿:
  - å¼•å¯¼ä¼˜åŒ–å™¨ç†è§£æ¼”åŒ–è½¨è¿¹
  - é˜²æ­¢è¿‡åº¦æ‘†åŠ¨
  - ç¡®ä¿æ”¹è¿›çš„è¿ç»­æ€§å’Œåˆç†æ€§
  - æ›´å¥½çš„æ”¶æ•›ç¨³å®šæ€§

  è¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆv2åœ¨BBHä»»åŠ¡ä¸Šèƒ½è¾¾åˆ°78.92%çš„ç¨³å®šå‡†ç¡®ç‡ï¼Œè€Œä¸”å‡†ç¡®ç‡æ³¢åŠ¨ç›¸å¯¹è¾ƒå°ï¼ˆ67%-85%ï¼‰